<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ“Š Statistiques de DÃ©bit Internet</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gradient-to-tr from-sky-50 to-white min-h-screen text-gray-800">
    <main class="max-w-6xl mx-auto p-6">
      <section class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-sky-600 mb-2">ðŸ“¶ Tableau de Bord du DÃ©bit Internet
        </h1>
        <p class="text-gray-500 text-lg">
          Suivi en temps rÃ©el de vos performances de connexion avec Fast.com
        </p>
      </section>

      <section id="stats" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        <div class="p-4 bg-white rounded-2xl shadow flex flex-col items-center">
          <div class="text-sm text-gray-500">Dernier dÃ©bit</div>
          <div id="stat-latest" class="text-3xl font-bold text-sky-600">--</div>
        </div>
        <div class="p-4 bg-white rounded-2xl shadow flex flex-col items-center">
          <div class="text-sm text-gray-500">Moyenne</div>
          <div id="stat-average" class="text-3xl font-bold text-sky-600">--</div>
        </div>
        <div class="p-4 bg-white rounded-2xl shadow flex flex-col items-center">
          <div class="text-sm text-gray-500">Tests totaux</div>
          <div id="stat-count" class="text-3xl font-bold text-sky-600">--</div>
        </div>
      </section>

      <section class="bg-white shadow-xl rounded-2xl p-6 mb-8">
        <div class="flex flex-wrap gap-2 justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-sky-700">Graphique du DÃ©bit</h2>
          <div class="flex gap-2">
            <button id="downloadCSV" class="bg-sky-600 text-white px-4 py-2 rounded hover:bg-sky-700 transition">ðŸ“„ Export CSV</button>
            <button id="clearOld" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">ðŸ—‘ï¸ Nettoyer (>7j)</button>
          </div>
        </div>
        <canvas id="speedChart" height="100"></canvas>
      </section>

      <section class="bg-white shadow-xl rounded-2xl p-6">
        <h2 class="text-xl font-semibold text-sky-700 mb-4">Historique des Mesures</h2>
        <div class="overflow-auto rounded-lg">
          <table class="min-w-full table-auto border-collapse">
            <thead class="bg-sky-700 text-white text-left">
              <tr>
                <th class="px-4 py-2">Horodatage</th>
                <th class="px-4 py-2">DÃ©bit (Mbps)</th>
                <th class="px-4 py-2">Ã‰tat</th>
                <th class="px-4 py-2">Action</th>
              </tr>
            </thead>
            <tbody id="dataTable" class="text-gray-700 divide-y divide-gray-200">
              <!-- InjectÃ© par JavaScript -->
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      let chart;
      let currentData = [];

      function updateData() {
        $.get('/api/data', function (data) {
          currentData = data;
          const labels = data.map((d) => new Date(d.timestamp).toLocaleTimeString());
          const speeds = data.map((d) => d.download_mbps);

          if (!chart) {
            chart = new Chart(document.getElementById('speedChart'), {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'DÃ©bit Mbps',
                    data: speeds,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14,165,233,0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                  },
                ],
              },
              options: {
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: { stepSize: 10 },
                  },
                },
              },
            });
          } else {
            chart.data.labels = labels;
            chart.data.datasets[0].data = speeds;
            chart.update();
          }

          const tableRows = data
            .slice()
            .reverse()
            .map((d) => {
              const speed = d.download_mbps;
              let badgeClass = 'bg-red-100 text-red-800', label = 'Lent';
              if (speed >= 100) badgeClass = 'bg-green-100 text-green-800', label = 'Rapide';
              else if (speed >= 30) badgeClass = 'bg-yellow-100 text-yellow-800', label = 'Moyen';

              return `
                <tr>
                  <td class="px-4 py-2 whitespace-nowrap">${new Date(d.timestamp).toLocaleString()}</td>
                  <td class="px-4 py-2 font-semibold">${speed}</td>
                  <td class="px-4 py-2">
                    <span class="px-2 py-1 rounded-full text-sm font-medium ${badgeClass}">${label}</span>
                  </td>
                  <td class="px-4 py-2 text-right">
                    <button data-ts="${d.timestamp}" class="delete-entry text-red-600 hover:underline">Supprimer</button>
                  </td>
                </tr>`;
            })
            .join('');

          $('#dataTable').html(tableRows);

          const count = data.length;
          document.getElementById('stat-count').textContent = count;
          if (count > 0) {
            const latest = data[count - 1].download_mbps;
            const average = Math.round(data.reduce((sum, d) => sum + d.download_mbps, 0) / count);
            document.getElementById('stat-latest').textContent = latest;
            document.getElementById('stat-average').textContent = average;
          }
        });
      }

      function downloadCSV() {
        const header = ['Horodatage', 'DÃ©bit (Mbps)', 'Ã‰tat'];
        const rows = currentData.map(row => {
          const speed = row.download_mbps;
          let state = 'Lent';
          if (speed >= 100) state = 'Rapide';
          else if (speed >= 30) state = 'Moyen';

          return [
            new Date(row.timestamp).toLocaleString(),
            speed,
            state
          ];
        });

        const table = [header, ...rows];
        const csv = table.map(row => row.map(cell => `"${cell}"`).join(";")) // point-virgule = sÃ©parateur de colonnes Excel FR
                      .join("\r\n");

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'statistiques_debit.csv');
        link.click();
      }

      document.getElementById('downloadCSV').addEventListener('click', downloadCSV);
      document.getElementById('clearOld').addEventListener('click', async () => {
        await fetch('/api/data/old', { method: 'DELETE' });
        updateData();
      });

      $(document).on('click', '.delete-entry', async function() {
        const ts = $(this).data('ts');
        await fetch(`/api/data/${ts}`, { method: 'DELETE' });
        updateData();
      });
      setInterval(updateData, 5000);
      updateData();
    </script>
  </body>
</html>
